# SawamuraEririAndSky

2023.12.6 try to build a fly controller step by step, using stm32. Although it's hard, it will be great fun!

## 1.实现PWM控制无刷电机可调速运动
    
### 1.1 使用外部中断加定时器的消抖动方式控制PWM波的输入输出
（电调初始化要求单片机连续输入差不多4s的占空比等于0.5的PWM【与网上说的相反。网络内容需谨慎对待https://zhuanlan.zhihu.com/p/42742897】，直至电调蜂鸣器响四声滴滴加一声长滴{四声短滴滴表示检测到是4S电池，NS电池就是响N声滴滴}，完成电调校准和准备；若检测到了输入PWM，但输入PWM一直在0.5占空比以上，则会发出连续不断的很急促的短滴滴，表示警告(一听就知道出事了)；若完全没有检测到输入PWM信号(或者有输入PWM信号，但单片机和电调没有共地，也按没有检测到输入计量)，则是间隔较长的不断短滴滴。
    检测到输入（即数声短滴滴和一声长滴滴以后），再输入任意高于0.5的pwm信号即可解锁电调。之后在占空比0.5至1.0的方波区间调整方波信号，即可实现电机变速驱动
1. TIM2进行0.1s定时：（PSC和ARR是单片机的计时器的参数。在HAL库写代码的时候用的。还不会的可以先学学STM32计时器原理。就看懂了） psc = 1600 - 1 定时器频率 = 16M/(PSC + 1) = 10000HZ （1万） T = (ARR + 1) / 10000 = 0.1S , 解得ARR = 1000 - 1
2. TIM3进行 500 / 10000 = 50ms的定时：用以按键消抖 (ARR = 499, 其他与TIM2相同)
3. TIM4输出pwm信号： 常规电调PWM信号频率最好是400HZ（网上主流说，电调检测的是脉冲宽度，**与PWM频率等无关**。FMS捕食者40A电调实测，400HZ，ARR 999, PSC 39, 在PWM_DUTY = 499开始转动，因此算出来最低脉冲长度是1.25ms，等待验证）因此 psc = 39, arr = 999  ps:均是在16M主频下的。
4. 电调四根控制线的功能  （ 电压是3-5V。另外，带BEC功能的电调，还可以给接收机或其它设备供电，BEC是Battery Elimination Circuit的简称，中文名叫电池电路。电调上的三根线（一红一黑一白），一根是接地，一根是BEC供电线，可以给舵机测试仪或者任何需要5V供电的东西供电。方向是电调->接收机/或是单片机，另一根是PWM线，方向是接收机->电调。有些电调不带BEC功能，那么只有两根线（一黑一白），一根接地，一根PWM线，方向是接收机->电调。）  也就是说，单片机控制的化只用共地和接PWM信号的线就可以了。红色的电源线不要接（不要接到单片机的5V上去啦！）
5. 无刷电机怎么控制？无刷电机能直接接电源吗？等等问题可以看： https://www.bilibili.com/video/BV1LE411p7QB/
6. 测试的时候，还是尽量不要改一个PWM，在电机仍转动的情况下烧录，来调电机。改动过程PWM波会有一个明显断层，电机会狠狠震一下，感觉挺伤机子的吧。建议写一个按键一点一点调PWM加上去或者用滑动编码器那些来搞
7. 测试一下到底是高电平控制还是占空比控制。若是占空比控制，那么改成500HZ刷新率，经计算，ARR改成800 - 1 即可。那么，一半占空比就是DUTY = 400，而1.25ms对应的duty是 1.25ms / 2ms * 800 = 500，啊？很奇怪，实验结果显示，是在DUTY = 465的时候启动。对应高电平时间为 1.15ms，对应占空比是 0.57625，很奇怪啊！  相比较而言，400HZ刷新率时，占空比是0.5，高电平持续时间1.25ms，都不成线性关系。看来还是以 400HZ刷新率为准较为合适。
8. 测出了电平大小，是高电平时间解锁。680um以下PWM默认当作没有pwm输入，680到800期间是正常输入，890左右启动pwm，超过890（未具体测）会急促鸣响报警，大概1000来um的持续输入，算是进入调试模式，或者能校准摇杆最大值。因此，我们将摇杆最低值设置在800um，摇杆最大值设置在2000um，采用400HZpwm波（最大时间2500um，不用就是了，有空余嘛）
## 2.初步搭建机架
###  2.1 飞机零件选择基本知识
####  2.1.1 飞机分类：
固定翼，多旋翼，直升机等     
* 固定翼理解为小的喷气式飞机，  
* 多旋翼就是多个螺旋桨的直升机的感觉？    
* 多旋翼，  选择四旋翼，  分为穿越机（竞速机，花飞机）（强调暴力）（一般较小），航拍机（强调稳定，续航等）（一般较大）    
这次不管那么多，选择大的机架方便调试
####  2.1.2 零件分类（由中心到四周）： 
1. 飞控， 飞机的处理器，中央大脑。一般传感器都在飞控上（也有气压计在四合一电调上的），各种电机呀，遥控器信号的接收机呀，图传（实时视频信号）的发射器呀，等等都连在飞控上，大脑。    
2. 电调： 接受飞控的PWM信号（一种方波信号，由“占空比”这一参数控制电机转速），由航模电池的直流电源供电，将直流电源转换为驱动无刷电机的三相交流电 （三项交流电是一会正一会负的交流电，航模电池是直流电，无刷电机当然不能直接接在电池上啦！），同时由飞控输出的信号调节电机转速     
3. 无刷电机：一种转的飞快，耗电量巨大无比的电机，由三相交流电供电（一黑一红一黄三条线，可以任意改变红，黄线与电调的连线顺序。这会改变电机旋转方向，且不会烧坏电机）。  主要需要考虑的参数：
    （1）KV值，比如，1500KV，  3000KV这些，代表  电压每增加  1V  ，电机旋转增加的圈数。   转的越快，耗电越快，相对来说力气就更小，但是反应更敏捷，更暴力。就像一个高攻速射手或者冲锋枪那样，伤害高但是续航差，且每一发的伤害低。    所以，一般大一点的飞机选择低KV值，提高拉力，保证效率，越暴力的穿越机选择越大的KV值（这么个道理，具体看实际情况）   
    （2）电机本身的大小：比如，一般电机有个参数写在前面，比如2212，从中间拆开来看，差不多22 指的是某种宽度，12指的是某种高度，一般来说穿越机的话选扁平一点的吧，一般XX10以下的？这个还请自己查资料，大部分机架呀淘宝都对这些有推荐。     本次选择的是： ”2212kv980航模电机马达F450 F550四轴多轴航模无刷电机自锁香蕉“         非常低的KV，很高的电机，因为是大飞机嘛，更低KV更大拉力，不竞速花飞啥的，主打一个便宜且随意。       
4. 遥控接收机：    暂定黑羊接收机。ELRS接收机，闭源的好像。要自己解码。用这个  https://github.com/CapnBry/CRServoF  国外大佬开源的ELRS转PWM的东西。            
5. 图传         
6. GPS：         
7. 云台：       
8. 机架：穿越机一般在七寸以下。  航拍机（悬停航拍）一般在七寸以上吧。机架几寸指能装几寸的桨叶。比如三寸机就只能装三寸桨。这次选了一个450MM轴距的大飞机，可以装10寸桨。  ”ZMR F450 V2四轴机架哪吒多旋翼沉金板PCB板耐炸FPV穿越机稳航拍“

## 3.实现PID调速的的代码
### 3.1 入门视频
https://www.bilibili.com/video/BV1zM4y157pk/  非常好且形象    P:比例 I：积分 D：微分   P：现在  I：过去  D：未来       P相当于一个弹簧，离预定距离越远，力越大。但是只有P会导致飞机一直在稳定区间上下震动，且P越大震动幅度越大，永远无法稳定。    D相当于一个随速度增加的阻力，D越大，阻力越大，与P搭配越容易稳定，但是响应越慢，手感越粘。D越小，飞机越容易“过冲”，惯性越大。 I是结合当前的所有外界干扰，快速计算处用来抵消的力，然后持续给予一个抵消的力，来使系统稳定。 I可以放大一点，以使系统快速稳定。但是如果外界干扰一直快速改变（风大且断断续续）的话，那么I就没用了反而难以操控。      综合：越大的飞机调PID越难，我干！  
### 3.2 Feedback 算法
学到了一个Feedback算法，就是指针速度加速，摇杆打杆结合Feedback可以让飞机更跟手，主要用于竞速穿越机。有兴趣后期可以学一下这个算法，先还是算了。

### 3.3 MPU6050的通信
* MPU6050通过I2C进行通信。
#### 3.3.1 MPU6050获得六轴加速度
* 加速度输出寄存器每一轴有16位，按照补码存储。最高位为0表示正数，1表示负数。例如 0000 0000 0000 0100 就表示 +4, 1111 1111 1111 1111 就表示-1。而16位有符号的数据最大值为65535，所以原始数据在显示时很容易在一个很小的数与一个很接近65535的数之间反复横跳。    
* MPU6050使用之前需要使能，初始化一下mpu6050的一些参数，详情见这篇文章 https://blog.csdn.net/wlisontj/article/details/131105692  然后使能的格式见 MPU6050.c 文件。 写了一个读取 三轴加速度和陀螺仪的函数。都很容易理解。
#### 3.1.2 通过MPU6050的DMP获得姿态数据
* DMP（Digital Motion Processor）是MPU6050芯片内部的一个数字运动处理器。DMP通过运行内置的算法，能够提供方便的输出数据，如欧拉角、四元数等，从而简化了对传感器原始数据的处理和分析。通过使用DMP功能，开发人员可以更加轻松地实现各种姿态相关应用，如倾斜度测量、姿态控制、运动捕捉等。
* 想要通过DMP来获得倾斜度，那么就必须要使用官方库eMPL。**然后注意，使用的时候尽量别直接修改库文件，因为这样做会导致后续再移植的时候出现问题**。要改的话最好是自己新建一个文件，然后从官方库里面复制东西。
* 关于如何移植，可以看视频：https://www.bilibili.com/video/BV13N4y1y7Js/ 。直接照搬一般是不行的。

### 3.4 二阶PID控制器（串级PID）



## 4.加装遥控部分，调整PID至能一定程度起飞    

## 5.加装后续功能

ps.其他准备：git 的使用，远程服务器暂定：D:\hardware\flyToTheFuckSky\MyFly
